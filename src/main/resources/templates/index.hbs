<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Chess Game</title>
    <link rel="stylesheet" href="/src/index.css">
</head>

<body>
    <div id="app">
        <h1>♟️ 체스</h1>
        <div class="form start">
            <form id="create-form" action="/create" method="post">
                <label for="title">방 제목</label>
                <input type="text" id="title" name="title">
                <label for="password">비밀번호</label>
                <input type="password" id="password" name="password">
                <button id="create-button">방 생성</button>
            </form>
        </div>
        <div class="room-list">
            <table id="room-table">
            </table>
        </div>
    </div>
</body>
<script type="text/javascript">
    function deleteRoom(id) {
        console.log('방 삭제 : ' + id);
        const passwordInput = window.prompt('방을 삭제하려면 비밀번호를 입력하세요');
        console.log('입력값: ' + passwordInput);
    }

    function loadGames() {
        fetch('./list')
            .then((response) => response.json())
            .then((games) => initializeRoomList(games));
    }

    function initializeRoomList(games) {
        const table = document.getElementById("room-table");
        table.innerHTML = "";
        games.forEach(game => table.appendChild(createGameTr(game)));
    }

    function createGameTr(game) {
        const tr = document.createElement('tr');
        tr.appendChild(createTitleTd(game));
        tr.appendChild(createDeleteTd(game));
        return tr;
    }

    function createTitleTd(game) {
        const td = document.createElement('td');
        const span = document.createElement('span');
        span.setAttribute('onclick', 'checkPassword(' + game.no + ')');
        span.setAttribute('class', 'room-title');
        span.innerHTML = game.title;
        td.appendChild(span);
        return td;
    }

    function createDeleteTd(game) {
        const td = document.createElement('td');
        const button = document.createElement('button');
        button.setAttribute('onclick', 'deleteRoom(' + game.no + ')');
        button.innerHTML = '삭제';
        td.appendChild(button);
        return td;
    }

   function checkPassword(gameNo) {
        const passwordInput = window.prompt('비밀번호를 입력하세요');
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = './load/' + gameNo;
        form.setAttribute('hidden', true);

        const formField = document.createElement('input');
        formField.type = 'hidden';
        formField.name = 'password';
        formField.value = passwordInput;

        form.appendChild(formField);
        document.body.appendChild(form);
        form.submit();
   }

    document.forms['create-form'].addEventListener('submit', (event) => {
        event.preventDefault();
        fetch(event.target.action, {
            method: 'POST',
            body: new URLSearchParams(new FormData(event.target))
        }).then((response) => response.status)
        .then((status) => alertCreateResult(status))
        .then(() => loadGames());
    });

    function alertCreateResult(status) {
        if (status !== 201) {
            window.alert("생성하지 못했습니다.");
            return;
        }
        window.alert("방 생성에 성공하였습니다.");
    }

    window.onload = function() {
        loadGames();
    }
</script>
</html>
